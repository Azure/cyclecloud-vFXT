
[environment vnet]
  Credentials = ${Credentials}
  Location = $Region
  ManagedLifecycle=true
  TemplateContents = ${vnetrawjson}
  ParameterValues.location = $Region
  ParameterValues.vnetName = ${ClusterName}-vnet

[cluster vfxt]
  Category = DataCache
  [[node defaults]]
    Credentials = $Credentials
    Region = $Region
    MachineType = Standard_D2_v3
    Azure.Identities = $ManagedIdentity2
    
    KeypairLocation = $KeypairLocation
    
  [[node shepherd]]
    ImageName = cycle.image.centos7
    IsReturnProxy = true
    SubnetId = ${vnet.resources[strcat(ClusterName, "-vnet")].properties.subnets.access.id}

      [[[cluster-init avere-vfxt:default:$ProjectVersion]]]
      [[[cluster-init avere-vfxt:vfxt:$ProjectVersion]]]

      [[[configuration]]]
        run_list = recipe[cyclecloud],recipe[cluster_init],recipe[dnsmasq::server]

        cyclecloud.hosts.standalone_dns.enabled = false
        cyclecloud.discoverable = true

      [[[configuration vfxt.cluster]]]
        subnet_id = ${vnet.resources[strcat(ClusterName, "-vnet")].properties.subnets.cache.id}
        username = admin
        password = $ClusterPassword
        storage_account = ${vnet.Outputs.storageAccountName}
        tenant_id = $AADTenantId
        managed_id = $ManagedIdentity2
        vmsize = $MachineType

  [[nodearray vfxt]]

    Azure.Publisher = microsoft-avere 
    Azure.Offer = vfxt
    Azure.Sku = avere-vfxt-node
    Azure.ImageVersion = 1.0.2
    Azure.OS = linux
    AwaitInstallation = False
    MachineType = $MachineType
    SubnetId = ${vnet.resources[strcat(ClusterName, "-vnet")].properties.subnets.cache.id}
    Azure.AllocationMethod=standalone
    UserData = blank

    InstallJetpack = False
    
    [[[network-interface eth0]]]
      EnableIpForwarding=true

    [[[volume d0]]]
      Size = 512
      SSD = true
      Azure.Lun = 0

    [[[volume d1]]]
      Size = 512
      SSD = true
      Azure.Lun = 1

    [[[volume d2]]]
      Size = 512
      SSD = true
      Azure.Lun = 2

    [[[volume d3]]]
      Size = 512
      SSD = true
      Azure.Lun = 3

    [[[volume d4]]]
      Size = 512
      SSD = true
      Azure.Lun = 4

    [[[volume d5]]]
      Size = 512
      SSD = true
      Azure.Lun = 5


[parameters all]
    [[parameter Credentials]]
    Description = The credentials for the cloud provider
    ParameterType = Cloud.Credentials
    
    [[parameter Region]]
    Label = Region
    Description = Deployment Location
    ParameterType = Cloud.Region

    [[parameter AADTenantId]] 
    Label = Tenant Id
    Description = AAD Tenant ID to help orchestrator
    Config.Plugin = pico.form.QueryDropdown
    Config.Query = select AzureRMTenantId as Name from credential 
    Required = true

    [[parameter KeypairLocation]]
    Label = Keypair Path
    Description = The path to the keypair
    DefaultValue = ~/.ssh/id_rsa_container
    Required = True

    [[parameter ManagedIdentity2]]
    Label = ManagedID
    Description = AAD User Assigned Managed Identity
    ParameterType = Azure.ManagedIdentity
    Required = True

    [[parameter MachineType]]
    Label = vFXT VM Size
    Description = VM Size for vFXT cluster nodes
    DefaultValue = Standard_D16s_v3        
    ParameterType = Cloud.MachineType
    Config.Filter := Name in {"Standard_D16s_v3", "Standard_E32s_v3"}

    [[parameter ClusterPassword]]
    DefaultValue = adminpass
    Label = vFXT Password
    Description = Admin password for vFXT interface
    Secret = True

    [[parameter ProjectVersion]]
    DefaultValue = 2.5.0
    Label = vFXT CC Version 
    Description = CycleCloud Project Version for vFXT